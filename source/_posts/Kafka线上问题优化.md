---
title: Kafka线上优化
categories: Kafka
tags: Kafka
---
 一、如何防止消息丢失
	 1.发送方：ack是1或者-1/all可以防止消息丢失，如果要做到99.9999%，ack设成all，把min.insync.replicas配置成分区备份数（返回ack才算成功否则一直发）
	 2.消费方：把自动提交改为手动提交
 二、如何防止消息的重复消费
	 在防止消息丢失的方案中，如果生产者发送完消息后，因为网络问题没有收到ack，但实际上broker已经收到了，此时生产者会进行重试，导致broker收到多条相同的消息。
	 通过消息的幂等性来解决消息的重复消费问题。
	 1.在数据库中传教联合主键，防止相同的主键创建出多条记录
	 2.分布式锁（redis）
 三、如何做到顺序消费（RocketMQ）
	 1.发送方：在发送时将ack不能设置0，关闭重试，使用同步发送，等到发送成功在发送下一条，保证消息时顺序发送的。
	 2.接收方，消息时发送到一个分区中，只能有一个消费组的消费者来接收消息。
	 因此kafka的顺序消费会牺牲性能
 四、解决消息积压问题
	 消费者的消费速度远赶不上生产者的生产速度，导致kafka中有大量的数据没有被消费，随着没有被消费的数据堆积越来越多，消费者寻址的性能会越来越差，最后导致整个kafka对外提供的服务的性能很差，从而造成其他服务访问速度也变慢，造成服务雪崩。
 
	 解决：在这个消费者中，使用多线程，充分利用机器的性能经行消费消息。
		   增大partion数量，
		   增加消费组服务数量
		   kafka单机升级成了集群
		   避免消费者消费消息时间过长，导致超时
 五、延迟队列
	 消费消息的时候判断消息的创建时间和当前时间是否达到设定的延迟时间，如果否，记录当前的offset，并不在继续消费，等到下次poll消息。
